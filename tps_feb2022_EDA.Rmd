---
title: 'TPS feb 2022 EDA'
date: '`r Sys.Date()`'
output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    fig_width: 7
    fig_height: 4.5
    theme: cosmo
    highlight: tango
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{css, echo=FALSE}
p {
  font-size: 17px;
}
```

```{r, include=FALSE}
Sys.setenv(LANG = "en")

```

# Short introduction

Welcome to this new and fresh February TPS! this month we will deal with genetics and the good news all features are senseful at least to genetic specialists! In this competition we will try to  classify 10 different bacteria species using data from a genomic analysis technique.

# About this notebook

This is a beginner level EDA, where I emphasis the most importante features of the data. You will encounter in this EDA : 

* Data structure exploration 

* The features importance 

* Highlights the most important relationships 

# Import libraries and data 

First, importing and preparing the data. The libraries used here are for data wrangling and visualizations. 

```{r, message= FALSE, warning= FALSE}
library(tidyverse)
library(data.table)
library(skimr)
library(corrplot)
library(ggforce)
library(cowplot)
library(patchwork)
library(gt)
library(scales)
library(viridis)

# data 
bacteria_train <- fread("train.csv")
bacteria_test <- fread("test.csv")
```

# Data structure exploration

## Overview 

```{r}
bacteria_train %>% 
  head(5) %>% 
  gt()
```

> Nice dataset, first look, first thinking : The names of features are informative, there is a lot that can be done!

## lets check the missing values 

```{r, warning=FALSE, message=FALSE}
bacteria_tt <- bind_rows(bacteria_train, bacteria_test, .id = "data")

is.na(bacteria_tt[, -c("target", "id", "data")]) %>% sum()

```

> NULL, no missing value for both dataset train and test

```{r, include=FALSE}
remove(bacteria_tt)
gc()
```

## Summary statistics

We propose a rapid overview of some statistics of a sample of 30 randomly selected features. 

```{r, warning=FALSE, message=FALSE}
skim <- bacteria_train %>% 
  skim() %>% 
  as_tibble()

skim_num <- skim %>% 
  filter(skim_type == "numeric", skim_variable != "id") %>% 
  select(skim_variable, numeric.mean:numeric.hist)

new_numNames <- skim_num %>% 
  names() %>% 
  str_remove_all("numeric.") %>% 
  str_remove("skim_")

names(skim_num) <- new_numNames

set.seed(123)

skim_num %>% 
  mutate(rank = row_number()) %>% 
  sample_n(30) %>% 
  arrange(rank) %>% 
  select(- rank) %>%
  gt() %>%
  gt::tab_header(
    title = "Summary statistics of 30 features randomly selected"
  ) %>% 
  gt::tab_options(data_row.padding = px(1))
```


> The range of the values for each feature is very large. So we expect large left skewness.

> The good thinks is that we deal with the same measure ("spectrophotometic") of dna for all features... This is really interesting for some features engineering.

# Target exploration 

We start our analysis by the target, ten species of bacteria to identify, not trough a microscopic images! But trough their DNA structure! 

## Target distribution 

Lets see the sample balance of the target. 

```{r, warning=FALSE, message=FALSE}
bacteria_train %>% 
  count(target) %>% 
  ggplot(aes(reorder(target, n), n, fill = target)) + 
  geom_col() +
  coord_flip() + 
  theme_minimal() + 
  theme(legend.position = "none") + 
  labs(y = "n",
       x = "Bacteria species",
       title = "target distribution")
```

> Great! All ten species are equaly distributed ~ 20000 sample for each one. 

## Feature importance 

The aim of this analysis is to identify the top twenty (20) most correlated features to each bacteria species. For this we use the correlation matrix, the correlations are directly related to the coefficients of a basic linear regression.

```{r, warning=FALSE, message=FALSE}
# target encoding with 1 & 0
bacteria_species <- bacteria_train$target %>% unique()

encod_matching <- function(x) {
  ifelse(bacteria_train$target == x, 1, 0)
}

targets <- lapply(bacteria_species, encod_matching)

names(targets) <- bacteria_species

x <- cbind(bacteria_train[, -c("row_id", "target")],
           as.data.table(targets))

# correlations 
x_corr <- cor(x, method = "pearson") %>% 
  as_tibble()

feature <- x_corr %>% names()

x_corr <- x_corr %>% 
  mutate(feature = feature) %>% 
  select(Streptococcus_pyogenes:feature) %>%
  filter(!(feature %in% bacteria_species)) %>% 
  mutate(across(where(is.double), abs))


# visualization 
featCorToTarget_plot <- function(df, target) {
  
  df %>% 
    arrange(desc(.data[[target]])) %>% 
    filter(row_number() %in% 1:20) %>% 
    ggplot(aes(reorder(feature, - .data[[target]]),
               .data[[target]],
               fill = feature)) + 
    geom_col(show.legend = FALSE) + 
    theme_minimal() + 
    labs(x = "",
         y = "Correlations",
         title = str_c(target)) + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
    
}

p <- lapply(bacteria_species, featCorToTarget_plot, df = x_corr)

p[[1]] + p[[2]]  
p[[3]] + p[[4]] 
p[[5]] + p[[6]]
p[[7]] + p[[8]]
p[[9]] + p[[10]]

```

> In Order :

> * *Klebsiella_pneumoniae* has the highest correlation scores with features with a top value of 0.557 with A1T1G4C4 which is very high for a binary regression ! 

> * Second, *Campylobacter_jejuni* with a top value 0.420 with A4T6G0C0.

> * This table summarize the results :

```{r}
top_cor <- x_corr %>% 
  select(where(is.numeric)) %>% 
  vapply(max, double(1))
                                    
top_feat <- vapply(x_corr, function(x) feature[x == max(x)], character(1))

tidy <- tibble(bacteria_target_species = names(top_cor),
               top_correlation = top_cor,
               feature_correlated_to = top_feat[-11]) %>% 
  filter(bacteria_target_species != "feature") %>% 
  arrange(desc(top_correlation)) %>% 
  mutate(rank = row_number(),
         top_correlation = as.double(top_correlation)) %>% 
  select(rank, everything())


tidy %>% 
  gt() %>% 
  tab_header(
    title = md("**Top couple of bacteria and feature correlation**"),
    )
```

> Interestingly some feature has repetitive occurance , like :

> * A1T2G3C4 which is the top correlated feature to both Salmonella_enterica and Streptococcus_pneumoniae.

> * A2T2G3C3 to Escherichia_coli and Escherichia_fergusonii.

*feature importance anlysis to be continued*

# Feature distribution 

Lets now see how the feature are individual distributed.

```{r, warning=FALSE}

density_plot <- function(df, x){

p <-   df %>% 
  ggplot(aes(.data[[x]])) +
  geom_density(fill = "blue") + 
  scale_y_continuous(labels = function(x) sprintf("%.1f", x)) +
  labs(y = "density")
    
p + 
  theme_minimal() +
  theme(legend.position = "none",
  legend.title = element_text(size= 5),
  legend.text = element_text(size= 5),
  legend.key.height = unit(1, 'mm'),
  legend.key.width = unit(4, 'mm'),
  legend.key.size = unit(0.5, "mm"),
  axis.title.y = element_text(size=8),
  axis.text.y = element_text(size=8),
  axis.text.x = element_text(size = 8),
  axis.title.x = element_text(size = 10))

}

features <- names(bacteria_train)[- c(1, 288)]
sample <- bacteria_train %>% sample_n(10000)

p <- lapply(features, density_plot, df = sample)

plot_grid(plotlist = p[1:20], align = "h", ncol = 4)
plot_grid(plotlist = p[21:40], align = "h", ncol = 4)
plot_grid(plotlist = p[41:60], align = "h", ncol = 4)
plot_grid(plotlist = p[61:80], align = "h", ncol = 4)
plot_grid(plotlist = p[81:100], align = "h", ncol = 4)
plot_grid(plotlist = p[101:120], align = "h", ncol = 4)
plot_grid(plotlist = p[121:140], align = "h", ncol = 4)
plot_grid(plotlist = p[141:160], align = "h", ncol = 4)
plot_grid(plotlist = p[161:180], align = "h", ncol = 4)
plot_grid(plotlist = p[181:200], align = "h", ncol = 4)
plot_grid(plotlist = p[201:220], align = "h", ncol = 4)
plot_grid(plotlist = p[221:240], align = "h", ncol = 4)
plot_grid(plotlist = p[241:260], align = "h", ncol = 4)
plot_grid(plotlist = p[261:286], align = "h", ncol = 4)
```

> As expected there distributions has a wide rage. 

> Left skeweness is a common feature of most data. 

# Feature Interactions

## Correlation heatmap 

Does features has strong relationship with each other? Lets see how they interact. We start by the correlation matrix 

```{r, warning=FALSE}

# correlaion matrix 
cor <- bacteria_train %>% 
  select(where(is_double), - row_id) %>% 
  cor() 

# Heat map
cor %>% 
  corrplot(method = "color", diag = FALSE, tl.pos='n')

```

> High interactions !!

> The heatmap of correlation matrix shown very interesting patterns! We can easly discern different mosaic of a square shape for both postive and negative correlations, these squares get smaller to the end of the data columns.. 

> We highly suggest to use correlations matrix for some feature engineering, the first exercice is to encode features given the square they belongs to! I'm pretty sure this will have high impact to the AUC !! Get FUN...

## Most interesting relationships 

We try first to identify the top ten strongly correlated features, and then apply a scatter plot function to highlight the nature of relationship.

```{r}
# Top correlations 
diag(cor) <- NA

top_cor <- cor %>% 
  as_tibble() %>% 
  mutate(feature_1 = dimnames(cor)[[1]]) %>% 
  pivot_longer(- feature_1, names_to = "feature_2", values_to = "cor") %>% 
  drop_na() %>% 
  mutate(cor_abs = abs(cor)) %>% 
  arrange(- cor_abs) %>% 
  mutate(rank = row_number()) %>% 
  select(rank, everything())

top_cor %>% 
  head(10) %>% 
  gt() %>% 
  tab_header(
    title = md("**Top ten couple of feature correlation**"),
    )


```

Lets Visualize the top one correlation 

```{r}

bacteria_train %>% 
  sample_frac(0.3) %>% 
  ggplot(aes(A1T2G6C1, A1T2G7C0)) + 
  geom_point(aes(col = target), size = 2) + 
  geom_smooth(method = "lm", formula = "y~x", col = "red") + 
  facet_zoom(x = A1T2G6C1 < 0.001, y = A1T2G7C0 < 0.0005) + 
  labs(title = "Top one correlation between A1T2G6C1 ~ A1T2G7C0, highlighted by target ") + 
  theme(legend.position = "top") 


```

> Wow ! becareful outliers before any conclusion! 

> It's clear now that each species has it's own pattern, clusturs are well defined. 

> Interractions are very strong ! I highly suggest based tree models.

**If you enjoy exploring this kernel please consider upvote**

*Stay tunned work still in progress*

